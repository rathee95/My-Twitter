{% extends "base.html" %}
{% block script %}

<script>

    //this function gets query strign values in js without any plugins 

    function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
    }


    $(document).ready(function(){
 
        var query = getParameterByName('q')
        var tweetList = [];

        function attachTweet(tweetValue,prepend)
        {

                    var tweetContent  = tweetValue.content;
                    var tweetUser = tweetValue.user;
                    var dateDisplay = tweetValue.date_display
                    var tweetFormattedHtml = "<div class=\"media\"> <div class=\"media-body\">" + tweetContent + "<br/> via " + tweetUser.username + " |  " + dateDisplay + " | " +  "<a href='#'>View</a>"+ "</div></div><hr>"
                    if(prepend == true)
                    {
                        $('#tweet-container').prepend(tweetFormattedHtml )
 
                    }
                    else 
                    {
                        $('#tweet-container').append( tweetFormattedHtml)
                    }

         }
         function parseTweet()
         {
            if(tweetList ==0)
            {
                   $('#tweet-container').text("No tweets currently found !!")

            }
            else // tweets exists , parse them 
            {
                $.each(tweetList,function(key,value){
                    var tweetkey = key;
                    attachTweet(value);
                     })
            }
        }
                

        function fetchTweets()
        {
            $.ajax({

            url:"/api/tweet/?q=" + query, //to our api
            data:{
                'q': query
            },
            method:"GET",
            success: function(data)
            {
                tweetList = data;
                parseTweet()
            },
            error:function(data)
            {   
                console.log("error"),
                console.log(data)
            }

            })
        }
        fetchTweets()



        $("#tweet-form").submit(function(event)
        {
               event.preventDefault();
            var this_ = $(this)
         
            var formData = this_.serialize();
            $.ajax({

            url:"/api/tweet/create/" , //to our api
            data:formData,
            method:"POST",
            success: function(data)
            {
                // console.log(data)
                attachTweet(data,true)
                this_.find("input[type=text], textarea").val("")
                // fetchTweets()   
            },
            error:function(data)
            {   
                console.log("error"),
                console.log(data),
                console.log(data.status)

            }

            })
        } )
    });
</script>
{% endblock script %}
 {% block title %} All Tweets {% endblock title %} 

 {% block content %}



<div class="row">
    <div class="col-sm-3 col-xs-12">
        <h1>{{ request.user }}</h1>
    </div>
    <div class="col-sm-9">
        {% if not request.GET.q %}
            <div class="">
            {% include "tweets/form.html" with form=create_form action_url=create_url btn_title='Tweet !!' form_id='tweet-form' %}
                
            </div>
            <hr/>
        {% endif %}

        <div id="tweet-container">
        </div>


        <!--DOING THIS VIA JS AND AJAX SO THAT WE DONT NEED TO RELOAD THE PAGE WHEN A NEW TWEET IS MADE !!! -->
<!--         {% for object in object_list %}
        <div class="media">
            <div class="media-left">
                {% if object.image %}<img src="img_avatar1.png" class="media-object" style="width:60px"> {% endif %}
            </div>
            <div class="media-body">
                {{ object.content }}
                <br/> via {{ object.user }} |{{ object.timestamp|timesince }} ago | <a href="{{ object.get_absolute_url }}"> View</a>
            </div>
        </div>
         {% empty %} {% if request.GET.q %}
        <p>No Tweets found </p>
        {% else %}
        <p>No Tweets yet </p>
        {% endif %} {% endfor %} -->
    </div>
</div>
{% endblock %}
